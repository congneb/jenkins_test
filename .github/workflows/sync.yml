name: Build Yocto Raspberry Pi Image

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-yocto:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          apt search libegl1-mesa
          echo ========================================
          
          sudo apt-get install -y \
            gawk wget git-core diffstat unzip texinfo gcc-multilib \
            build-essential chrpath socat cpio python3 python3-pip python3-pexpect \
            xz-utils debianutils iputils-ping python3-git python3-jinja2 \
            libegl1-mesa libsdl1.2-dev pylint xterm python3-subunit \
            mesa-common-dev zstd liblz4-tool

      - name: Setup sstate cache
        uses: actions/cache@v4
        with:
          path: |
            build/sstate-cache
          key: yocto-sstate-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            yocto-sstate-${{ runner.os }}

      - name: Initialize Yocto build environment
        run: |
          if [ ! -d poky ]; then
            git clone --branch kirkstone git://git.yoctoproject.org/poky.git poky
          fi  
          # Optionally add Raspberry Pi layer and meta-openembedded
          if [ ! -d meta-raspberrypi ]; then
            git clone --branch kirkstone git://git.yoctoproject.org/meta-raspberrypi
          fi
          if [ ! -d meta-openembedded ]; then
            git clone --branch kirkstone git://git.openembedded.org/meta-openembedded
          fi

      - name: Configure Yocto for Raspberry Pi
        run: |
          source poky/oe-init-build-env
          cp ../poky/meta-poky/conf/local.conf.sample conf/local.conf
          echo 'MACHINE = "raspberrypi4"' >> conf/local.conf
          bitbake-layers add-layer ../meta-raspberrypi
          bitbake-layers add-layer ../meta-openembedded/meta-oe
          bitbake-layers add-layer ../meta-openembedded/meta-networking

      - name: Build Yocto image
        run: |
          source poky/oe-init-build-env
          bitbake core-image-minimal

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: raspberrypi-image
          path: |
            build/tmp/deploy/images/raspberrypi4/core-image-minimal-raspberrypi4*.wic.bz2
